<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS Lemons üçã (Appwrite)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        .view { display: none; }
        #feed, #chat-messages { max-height: 60vh; overflow-y: auto; }
        #user-list { max-height: 60vh; overflow-y: auto; }
        .post, .message, .user-item { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-yellow-50 font-sans">

    <!-- Error Message Display -->
    <div id="error-bar" class="hidden fixed top-0 left-0 right-0 p-3 bg-red-500 text-white text-center z-50">
        <span id="error-message"></span>
        <button onclick="document.getElementById('error-bar').classList.add('hidden')" class="float-right font-bold">&times;</button>
    </div>

    <!-- Login View -->
    <div id="login-view" class="view container mx-auto max-w-sm p-8 mt-20 bg-white rounded-lg shadow-md">
        <h1 class="text-3xl font-bold text-yellow-700 text-center mb-6">SGS Lemons üçã</h1>
        <h2 class="text-2xl font-semibold text-center mb-4">Login</h2>
        <input id="login-email" type="email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
        <input id="login-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
        <button id="login-button" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-yellow-600">Login</button>
        <p class="text-center text-sm text-gray-600 mt-4">
            No account? <button id="show-register-button" class="text-yellow-600 hover:underline">Register here</button>
        </p>
    </div>

    <!-- Register View -->
    <div id="register-view" class="view container mx-auto max-w-sm p-8 mt-20 bg-white rounded-lg shadow-md">
        <h1 class="text-3xl font-bold text-yellow-700 text-center mb-6">SGS Lemons üçã</h1>
        <h2 class="text-2xl font-semibold text-center mb-4">Register</h2>
        <input id="register-name" type="text" placeholder="Your Name" class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
        <input id="register-email" type="email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
        <input id="register-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
        <button id="register-button" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-blue-600">Register</button>
        <p class="text-center text-sm text-gray-600 mt-4">
            Already have an account? <button id="show-login-button" class="text-yellow-600 hover:underline">Login here</button>
        </p>
    </div>

    <!-- App View (Main App) -->
    <div id="app-view" class="view container mx-auto max-w-4xl p-4 sm:p-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-4 pb-4 border-b border-yellow-200">
            <h1 class="text-4xl font-bold text-yellow-700">SGS Lemons üçã</h1>
            <div class="text-right">
                <div id="user-status" class="text-sm font-semibold text-gray-700">Connecting...</div>
                <button id="logout-button" class="text-sm text-red-500 hover:underline">Logout</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-4">
            <button id="show-feed-tab" class="py-2 px-4 bg-yellow-500 text-white font-semibold rounded-t-lg">Public Feed</button>
            <button id="show-chats-tab" class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-t-lg">Private Chats</button>
        </div>

        <!-- Public Feed Content -->
        <div id="feed-content">
            <!-- New Post Form -->
            <div class="mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Create a new post</h2>
                <textarea id="post-text" class="w-full h-24 p-3 border rounded-lg" placeholder="What's on your mind?"></textarea>
                <button id="post-button" class="mt-3 w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-yellow-600">Post</button>
            </div>
            <!-- Post Feed -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Feed</h2>
                <div id="feed" class="space-y-4">
                    <p id="loading-state" class="text-gray-500 text-center">Loading posts...</p>
                </div>
            </div>
        </div>

        <!-- Private Chats Content -->
        <div id="chats-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- User List -->
                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-3">Users</h2>
                    <div id="user-list" class="space-y-2">
                        <p id="loading-users" class="text-gray-500 text-center">Loading users...</p>
                    </div>
                </div>

                <!-- Chat Window -->
                <div class="md:col-span-2 bg-white p-4 rounded-lg shadow-md">
                    <h2 id="chat-with-name" class="text-xl font-semibold text-gray-800 mb-3">Select a user to chat</h2>
                    <div id="chat-messages" class="space-y-3 mb-4 p-3 bg-gray-50 rounded-lg border">
                        <p id="chat-prompt" class="text-gray-500 text-center">Messages will appear here.</p>
                    </div>
                    <div id="chat-input-area" class="flex hidden">
                        <input id="chat-text" type="text" placeholder="Type your message..." class="flex-grow p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <button id="chat-send-button" class="bg-yellow-500 text-white font-bold py-3 px-5 rounded-r-lg hover:bg-yellow-600">Send</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. YOUR IDS ---
        const APPWRITE_PROJECT_ID = '690b84bd001410050b0d';
        const APPWRITE_DATABASE_ID = '690b84fe00256ca543e2';
        
        const APPWRITE_POSTS_COLLECTION_ID = 'posts';
        const APPWRITE_USERS_COLLECTION_ID = 'users'; 
        const APPWRITE_CHATS_COLLECTION_ID = 'chats'; 
        // -----------------------------

        const { Client, Databases, ID, Account, Query, Permission, Role } = Appwrite;

        // --- DOM Elements ---
        const views = {
            login: document.getElementById('login-view'),
            register: document.getElementById('register-view'),
            app: document.getElementById('app-view')
        };
        const errorBar = document.getElementById('error-bar');
        const errorMessage = document.getElementById('error-message');
        
        // Auth
        const loginEmailEl = document.getElementById('login-email');
        const loginPasswordEl = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const registerNameEl = document.getElementById('register-name');
        const registerEmailEl = document.getElementById('register-email');
        const registerPasswordEl = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const showLoginButton = document.getElementById('show-login-button');
        const showRegisterButton = document.getElementById('show-register-button');
        const logoutButton = document.getElementById('logout-button');
        const userStatusEl = document.getElementById('user-status');

        // Tabs
        const showFeedTab = document.getElementById('show-feed-tab');
        const showChatsTab = document.getElementById('show-chats-tab');
        const feedContent = document.getElementById('feed-content');
        const chatsContent = document.getElementById('chats-content');

        // Feed
        const postTextEl = document.getElementById('post-text');
        const postButtonEl = document.getElementById('post-button');
        const feedEl = document.getElementById('feed');
        const loadingStateEl = document.getElementById('loading-state');

        // Chats
        const userListEl = document.getElementById('user-list');
        const loadingUsersEl = document.getElementById('loading-users');
        const chatWithNameEl = document.getElementById('chat-with-name');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatPromptEl = document.getElementById('chat-prompt');
        const chatInputArea = document.getElementById('chat-input-area');
        const chatTextEl = document.getElementById('chat-text');
        const chatSendButton = document.getElementById('chat-send-button');

        // --- Appwrite Client ---
        const client = new Client();
        client
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject(APPWRITE_PROJECT_ID);

        const databases = new Databases(client);
        const account = new Account(client);

        // --- App State ---
        let currentUser = null;
        let selectedChatUserId = null;
        let unsubscribePosts = () => {};
        let unsubscribeChats = () => {};

        // --- Utility Functions ---
        function showView(viewName) {
            Object.values(views).forEach(v => v.style.display = 'none');
            views[viewName].style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBar.classList.remove('hidden');
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        // --- 1. Authentication ---
        async function initAuth() {
            try {
                currentUser = await account.get();
                userStatusEl.textContent = `Welcome, ${currentUser.name}!`;
                showView('app');
                loadApp();
            } catch (error) {
                console.log("No active session.");
                showView('login');
            }
        }

        async function handleLogin() {
            try {
                await account.createEmailPasswordSession(loginEmailEl.value, loginPasswordEl.value);
                await initAuth(); 
            } catch (error) {
                console.error("Login failed:", error);
                showError(`Login failed: ${error.message}`);
            }
        }

        async function handleRegister() {
            const name = registerNameEl.value;
            const email = registerEmailEl.value;
            const password = registerPasswordEl.value;
            if (!name || !email || !password) {
                return showError("All fields are required.");
            }

            let newUser; // To store the user if created
            try {
                // 1. Create the user account
                console.log("Step 1: Creating auth user...");
                newUser = await account.create(ID.unique(), email, password, name);
                console.log("Step 1 SUCCESS:", newUser);

                // 2. Log the new user in (DO THIS *BEFORE* WRITING TO DB)
                console.log("Step 2: Creating session...");
                await account.createEmailPasswordSession(email, password);
                console.log("Step 2 SUCCESS.");

                // 3. Add user to the public 'users' collection (NOW THE USER HAS 'Users' ROLE)
                console.log("Step 3: Creating user document in 'users' collection...");
                await databases.createDocument(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_USERS_COLLECTION_ID,
                    newUser.$id, // Use the user's ID as the document ID
                    { name: name },
                    [
                        Permission.read(Role.any()), // Let anyone read this user's name
                        Permission.update(Role.user(newUser.$id)) // Only this user can update their name
                    ]
                );
                console.log("Step 3 SUCCESS.");
                
                await initAuth(); // All done, load the app
            
            } catch (error) {
                console.error("Registration failed:", error);

                // Better Error Messages
                let publicError = `Registration failed: ${error.message}`;

                if (error.code === 409) { // Conflict
                    publicError = "Registration failed. This email is already in use.";
                } else if (error.message.includes("permission") || error.code === 401 || error.code === 403) {
                    publicError = "Registration failed. Check 'users' collection permissions.";
                } else if (error.message.includes("not found") || error.code === 404) {
                    publicError = "Registration failed. Database or Collection ID is wrong.";
                } else if (error.message.includes("Column") || error.message.includes("Attribute")) {
                     publicError = "Registration failed. 'users' collection is missing the 'name' column.";
                }

                showError(publicError);

                if (newUser && (error.code === 401 || error.code === 403 || error.code === 400)) {
                    console.log("Rolling back: Deleting created auth user...");
                    try {
                        await account.createEmailPasswordSession(email, password);
                        await account.delete(newUser.$id); 
                        console.log("Rollback complete.");
                    } catch (e) {
                        console.error("Rollback failed", e);
                    }
                }
            }
        }

        async function handleLogout() {
            try {
                await account.deleteSession('current');
                currentUser = null;
                showView('login');
                unsubscribePosts();
                unsubscribeChats();
            } catch (error) {
                console.error("Logout failed:", error);
                showError("Logout failed.");
            }
        }

        // --- 2. Main App Logic ---
        function loadApp() {
            loadPosts();
            loadUserList();
            subscribeToPosts();
            subscribeToChats();
        }

        // --- 3. Public Feed (Posts) ---
        async function loadPosts() {
            loadingStateEl.style.display = 'block';
            try {
                const response = await databases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_POSTS_COLLECTION_ID,
                    [Query.orderDesc("$createdAt")]
                );
                feedEl.innerHTML = '';
                if (response.documents.length === 0) {
                    loadingStateEl.textContent = "No posts yet. Be the first!";
                } else {
                    loadingStateEl.style.display = 'none';
                    response.documents.forEach(doc => renderPost(doc));
                }
            } catch (error) {
                console.error("Error loading posts:", error);
                loadingStateEl.textContent = "Error loading feed. Check 'posts' collection permissions.";
            }
        }

        function renderPost(post) {
            const postEl = document.createElement('div');
            postEl.className = 'bg-white p-4 rounded-lg shadow-md post';
            const postDate = new Date(post.$createdAt).toLocaleString();
            postEl.innerHTML = `
                <p class="text-gray-800">${escapeHTML(post.text)}</p>
                <div class="text-xs text-gray-500 mt-3 flex justify-between">
                    <span>By: ${post.authorName || 'Anonymous'}</span>
                    <span>${postDate}</span>
                </div>
            `;
            feedEl.prepend(postEl); 
        }

async function handleAddPost() {
            const postText = postTextEl.value.trim();
            if (!postText) return;

            postButtonEl.disabled = true;
            try {
                await databases.createDocument(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_POSTS_COLLECTION_ID,
                    ID.unique(),
                    {
                        text: postText,
                        authorId: currentUser.$id,
                        authorName: currentUser.name 
                    },
                    [
                        Permission.read(Role.any()) // Let anyone read posts
                    ]
                );
                postTextEl.value = '';
            } catch (error) {
                console.error("Error adding post:", error);
                showError("Error saving post. Check 'posts' collection permissions.");
            } finally {
                postButtonEl.disabled = false;
            }
        }

        function subscribeToPosts() {
            unsubscribePosts = client.subscribe(
                `databases.${APPWRITE_DATABASE_ID}.collections.${APPWRITE_POSTS_COLLECTION_ID}.documents`, 
                response => {
                    if (response.events.includes("databases.*.collections.*.documents.*.create")) {
                        console.log("Real-time: New post");
                        loadingStateEl.style.display = 'none';
                        renderPost(response.payload);
                    }
                }
            );
        }

        // --- 4. Private Chats ---
        async function loadUserList() {
            loadingUsersEl.style.display = 'block';
            try {
                const response = await databases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_USERS_COLLECTION_ID
                );
                userListEl.innerHTML = '';
                response.documents
                    .filter(user => user.$id !== currentUser.$id) 
                    .forEach(user => {
                        const userEl = document.createElement('button');
                        userEl.className = 'block w-full text-left p-3 bg-gray-50 hover:bg-yellow-100 rounded-lg user-item';
                        userEl.textContent = user.name;
                        userEl.onclick = () => openChat(user.$id, user.name);
                        userListEl.appendChild(userEl);
                    });
                loadingUsersEl.style.display = 'none';
            } catch (error) {
                console.error("Error loading users:", error);
                loadingUsersEl.textContent = "Error loading users. Check 'users' collection permissions.";
            }
        }

        async function openChat(userId, userName) {
            selectedChatUserId = userId;
            chatWithNameEl.textContent = `Chat with ${userName}`;
            chatMessagesEl.innerHTML = '';
            chatPromptEl.style.display = 'block';
            chatPromptEl.textContent = 'Loading messages...';
            chatInputArea.classList.remove('hidden');

            try {
                const response = await databases.listDocuments(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_CHATS_COLLECTION_ID,
                    [
                        Query.or([
                            Query.and([
                                Query.equal('senderId', currentUser.$id),
                                Query.equal('receiverId', userId)
                            ]),
                            Query.and([
                                Query.equal('senderId', userId),
                                Query.equal('receiverId', currentUser.$id)
                            ])
                        ])
                    ],
                    [Query.orderAsc("$createdAt")]
                );
                
                chatPromptEl.style.display = 'none';
                if (response.documents.length === 0) {
                    chatPromptEl.textContent = 'No messages yet. Say hi!';
                    chatPromptEl.style.display = 'block';
                }
                response.documents.forEach(msg => renderMessage(msg, false));
            } catch (e) {
                console.error("Chat query error:", e);
                chatPromptEl.textContent = "Error loading chat. (Did you create the indexes?)";
            }
        }

        function renderMessage(message, isNew = false) {
            chatPromptEl.style.display = 'none';
            // *** THIS IS THE LINE I FIXED ***
            const msgEl = document.createElement('div'); 
            
            const isMe = message.senderId === currentUser.$id;
            
            msgEl.className = `p-3 rounded-lg max-w-xs ${isMe ? 'bg-yellow-200 ml-auto' : 'bg-gray-200'}`;
            msgEl.innerHTML = `<p>${escapeHTML(message.message)}</p>`;
            if (isNew) {
                msgEl.classList.add('message'); 
            }
            chatMessagesEl.appendChild(msgEl);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; 
        }

        async function handleSendMessage() {
            const messageText = chatTextEl.value.trim();
            if (!messageText || !selectedChatUserId) return;

            chatSendButton.disabled = true;
            try {
                await databases.createDocument(
                    APPWRITE_DATABASE_ID,
                    APPWRITE_CHATS_COLLECTION_ID,
                    ID.unique(),
                    {
                        message: messageText,
                        senderId: currentUser.$id,
                        receiverId: selectedChatUserId
                    },
                    [
                        Permission.read(Role.user(currentUser.$id)),
                        Permission.read(Role.user(selectedChatUserId))
                    ]
                );
                chatTextEl.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showError("Error sending message.");
            } finally {
                chatSendButton.disabled = false;
            }
        }

        function subscribeToChats() {
            unsubscribeChats = client.subscribe(
                `databases.${APPWRITE_DATABASE_ID}.collections.${APPWRITE_CHATS_COLLECTION_ID}.documents`,
                response => {
                    if (response.events.includes("databases.*.collections.*.documents.*.create")) {
                        const message = response.payload;
                        const { senderId, receiverId } = message;
                        
                        if (selectedChatUserId &&
                            ((senderId === currentUser.$id && receiverId === selectedChatUserId) ||
                             (senderId === selectedChatUserId && receiverId === currentUser.$id))
                        ) {
                            console.log("Real-time: New message");
                            renderMessage(message, true);
                        }
                    }
                }
            );
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', handleLogin);
        registerButton.addEventListener('click', handleRegister);
        logoutButton.addEventListener('click', handleLogout);
        showLoginButton.addEventListener('click', () => showView('login'));
        showRegisterButton.addEventListener('click', () => showView('register'));
        
        // Tabs
        showFeedTab.addEventListener('click', () => {
            feedContent.style.display = 'block';
            chatsContent.style.display = 'none';
            showFeedTab.classList.replace('bg-gray-200', 'bg-yellow-500');
            showFeedTab.classList.add('text-white');
            showChatsTab.classList.replace('bg-yellow-500', 'bg-gray-200');
            showChatsTab.classList.remove('text-white');
        });
        showChatsTab.addEventListener('click', () => {
            feedContent.style.display = 'none';
            chatsContent.style.display = 'block';
            showFeedTab.classList.replace('bg-yellow-500', 'bg-gray-200');
            showFeedTab.classList.remove('text-white');
            showChatsTab.classList.replace('bg-gray-200', 'bg-yellow-500');
            showChatsTab.classList.add('text-white');
        });

        // App Actions
        postButtonEl.addEventListener('click', handleAddPost);
        chatSendButton.addEventListener('click', handleSendMessage);
        chatTextEl.addEventListener('keypress', e => {
            if (e.key === 'Enter') handleSendMessage();
        });

// --- Initial Load ---
        initAuth();

    </script>
</body>
</html>
